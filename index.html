<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance Pro - Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-12">

    <!-- Header & Navegação -->
    <header class="bg-white border-b sticky top-0 z-30">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <span class="bg-blue-600 text-white p-1.5 rounded-lg">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                </span>
                MyFinance
            </h1>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-xl">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition-all">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m15 18-6-6 6-6"></path></svg>
                    </button>
                    <span id="currentMonthLabel" class="text-sm font-semibold px-2 min-w-[120px] text-center capitalize">Janeiro 2024</span>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition-all">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m9 18 6-6-6-6"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-5 rounded-2xl border shadow-sm">
                <p class="text-slate-500 text-xs font-bold uppercase mb-1">Saldo Mensal</p>
                <h3 id="totalBalance" class="text-2xl font-bold text-slate-800">R$ 0,00</h3>
            </div>
            <div class="bg-white p-5 rounded-2xl border shadow-sm">
                <p class="text-emerald-500 text-xs font-bold uppercase mb-1">Entradas</p>
                <h3 id="totalIn" class="text-2xl font-bold text-emerald-600">R$ 0,00</h3>
            </div>
            <div class="bg-white p-5 rounded-2xl border shadow-sm">
                <p class="text-rose-500 text-xs font-bold uppercase mb-1">Saídas</p>
                <h3 id="totalOut" class="text-2xl font-bold text-rose-600">R$ 0,00</h3>
            </div>
            <!-- Meta Card -->
            <div id="goalCard" class="bg-white p-5 rounded-2xl border shadow-sm flex flex-col justify-between border-l-4">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-amber-600 text-xs font-bold uppercase">Meta (Poupar 1/3)</p>
                    <span id="goalStatus" class="text-[10px] px-2 py-0.5 rounded-full font-bold"></span>
                </div>
                <div class="space-y-1">
                    <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                        <div id="goalProgress" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="goalText" class="text-[10px] text-slate-400 mt-1"></p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div class="flex gap-4">
                    <button onclick="openModal()" class="flex-1 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-bold shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
                        Novo Lançamento
                    </button>
                    <button onclick="exportToCSV()" class="px-6 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-2xl font-bold transition-all flex items-center justify-center gap-2">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"></path></svg>
                        Exportar
                    </button>
                </div>

                <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-5 border-b flex items-center justify-between">
                        <h2 class="font-bold text-slate-800">Histórico de Transações</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-500 text-[11px] uppercase tracking-wider">
                                <tr>
                                    <th class="px-6 py-4 font-semibold">Data</th>
                                    <th class="px-6 py-4 font-semibold">Descrição</th>
                                    <th class="px-6 py-4 font-semibold">Valor</th>
                                    <th class="px-6 py-4 font-semibold text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="transactionBody" class="divide-y text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-white p-6 rounded-2xl border shadow-sm">
                    <h2 class="font-bold text-slate-800 mb-6">Gastos por Categoria</h2>
                    <div id="chartContainer" class="flex flex-col items-center">
                        <div id="emptyChart" class="py-12 text-center text-slate-400 text-sm">
                            Nenhum gasto registado este mês.
                        </div>
                        <div id="chartGraphic" class="hidden relative w-48 h-48 mb-6">
                            <svg viewBox="0 0 36 36" class="w-full h-full transform -rotate-90">
                                <circle cx="18" cy="18" r="15.9" fill="transparent" stroke="#f1f5f9" stroke-width="3"></circle>
                                <g id="chartSlices"></g>
                            </svg>
                        </div>
                        <div id="chartLegend" class="w-full space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Formulário -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="px-6 py-4 border-b bg-slate-50 flex items-center justify-between">
                <h3 id="modalTitle" class="font-bold text-slate-800">Nova Transação</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <form id="financeForm" class="p-6 space-y-4">
                <input type="hidden" id="editId">
                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button type="button" onclick="setType('saida')" id="btnSaida" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white text-rose-600 shadow-sm transition-all">Saída</button>
                    <button type="button" onclick="setType('entrada')" id="btnEntrada" class="flex-1 py-2 rounded-lg text-sm font-bold text-slate-400 transition-all">Entrada</button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-slate-500 mb-1">Descrição / Serviço</label>
                        <input type="text" id="desc" required class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Freelance Logo, Salário Mensal...">
                    </div>
                    
                    <!-- Campo Fonte (Exclusivo para Entradas) -->
                    <div id="sourceFieldDiv" class="col-span-2 hidden animate-in slide-in-from-top-2">
                        <label class="block text-xs font-bold text-emerald-600 mb-1 uppercase tracking-tighter">Fonte (Quem pagou?)</label>
                        <input type="text" id="source" class="w-full px-4 py-2.5 border border-emerald-200 rounded-xl outline-none bg-emerald-50 focus:ring-2 focus:ring-emerald-500" placeholder="Ex: Empresa XYZ, João Silva...">
                    </div>

                    <div><label class="block text-xs font-bold text-slate-500 mb-1">Valor (R$)</label><input type="number" step="0.01" id="val" required class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="0,00"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">Data</label><input type="date" id="date" required class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" onchange="updateLastInstallment()"></div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Categoria</label>
                        <select id="cat" class="w-full px-4 py-2.5 border rounded-xl outline-none bg-white">
                            <!-- JS Injected Options -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Forma de Pagamento</label>
                        <select id="method" onchange="checkCreditMethod()" class="w-full px-4 py-2.5 border rounded-xl outline-none bg-white">
                            <option>Pix</option><option>Pix Agendado</option><option>Crédito</option><option>Débito</option><option>Boleto</option><option>Dinheiro</option>
                        </select>
                    </div>
                    <div id="cardSelectorDiv" class="col-span-2 hidden animate-in slide-in-from-top-2">
                        <label class="block text-xs font-bold text-blue-500 mb-1 uppercase tracking-tighter">Cartão Utilizado</label>
                        <select id="cardUsed" class="w-full px-4 py-2.5 border border-blue-200 rounded-xl outline-none bg-blue-50">
                            <option value="">Selecione o cartão...</option>
                            <option>NuBank</option>
                            <option>Inter</option>
                            <option>Visa Platinum</option>
                            <option>Mastercard Black</option>
                            <option>American Express</option>
                        </select>
                    </div>
                </div>

                <!-- Opções de Recorrência -->
                <div id="recurrenceDiv" class="bg-slate-50 p-4 rounded-2xl border border-slate-200 space-y-3">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="isInstallment" onchange="handleRecurrence('installment')" class="w-4 h-4 text-blue-600 rounded">
                            <span id="labelInstallment" class="text-xs font-bold text-slate-700">Parcelado?</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="isFixed" onchange="handleRecurrence('fixed')" class="w-4 h-4 text-emerald-600 rounded">
                            <span id="labelFixed" class="text-xs font-bold text-slate-700">Recorrência Fixa?</span>
                        </label>
                    </div>

                    <div id="installmentFields" class="hidden grid grid-cols-2 gap-4 animate-in slide-in-from-top-1">
                        <div><label class="block text-[10px] font-bold text-blue-400 mb-1 uppercase">Quantidade</label><input type="number" id="installCount" min="2" value="2" oninput="updateLastInstallment()" class="w-full px-3 py-1.5 border rounded-lg outline-none"></div>
                        <div><label class="block text-[10px] font-bold text-blue-400 mb-1 uppercase">Última Parcela</label><div id="lastInstallLabel" class="text-sm font-bold text-blue-700 py-1.5">—</div></div>
                    </div>
                    <div id="fixedFields" class="hidden grid grid-cols-2 gap-4 animate-in slide-in-from-top-1 items-end">
                        <div><label class="block text-[10px] font-bold text-emerald-500 mb-1 uppercase">Duração (meses)</label><input type="number" id="fixedDuration" min="1" value="12" class="w-full px-3 py-1.5 border rounded-lg outline-none"></div>
                        <div class="text-[9px] text-emerald-600 font-medium leading-tight pb-1">Repetir este lançamento mensalmente pelo período selecionado.</div>
                    </div>
                </div>

                <button type="submit" class="w-full py-3.5 bg-slate-800 hover:bg-black text-white rounded-xl font-bold transition-all shadow-lg">Guardar Lançamento</button>
            </form>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const EXPENSE_CATEGORIES = [
            'Alimentação', 'Moradia', 'Combustível', 'Manutenção carro', 
            'Lazer', 'Saúde', 'Pets', 'Educação', 'Manutenção casa', 
            'Vestuário', 'Cosméticos', 'Eletrônicos', 'Presentes', 'Transporte'
        ];
        const INCOME_CATEGORIES = ['Salário', 'Freelance', 'Presentes'];

        // --- Persistence Logic ---
        const STORAGE_KEY = 'myfinance_data_v6'; 
        let transactions = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [
            { id: 1, desc: 'Salário Exemplo', val: 4500, date: new Date().toISOString().split('T')[0], type: 'entrada', cat: 'Salário', method: 'Pix', isInstallment: false, isFixed: false, source: 'Minha Empresa' }
        ];

        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
        }

        // --- Core Functions ---
        let currentMonth = new Date();
        let currentType = 'saida';
        const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#71717a'];

        function init() { render(); updateLastInstallment(); }

        function render() {
            updateLabels();
            const filtered = getFilteredData();
            renderTable(filtered);
            renderStats(filtered);
            renderChart(filtered);
            saveToStorage();
        }

        function updateLabels() {
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            document.getElementById('currentMonthLabel').innerText = `${months[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
            if(!document.getElementById('editId').value) document.getElementById('date').value = new Date().toISOString().split('T')[0];
        }

        function getFilteredData() {
            return transactions.filter(t => {
                const d = new Date(t.date + 'T12:00:00');
                return d.getMonth() === currentMonth.getMonth() && d.getFullYear() === currentMonth.getFullYear();
            });
        }

        function renderTable(data) {
            const body = document.getElementById('transactionBody');
            if (data.length === 0) {
                body.innerHTML = '<tr><td colspan="4" class="px-6 py-10 text-center text-slate-400">Sem registos este mês.</td></tr>';
                return;
            }
            body.innerHTML = data.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => `
                <tr class="hover:bg-slate-50 transition-colors group">
                    <td class="px-6 py-4 text-slate-500 whitespace-nowrap">${t.date.split('-').reverse().join('/')}</td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-slate-700 flex items-center gap-1.5">
                            ${t.desc}
                            ${t.isFixed ? '<span title="Lançamento Fixo/Recorrente" class="text-emerald-500"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></span>' : ''}
                        </div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold">
                            ${t.cat} • ${t.method}${t.cardUsed ? ` (${t.cardUsed})` : ''} 
                            ${t.source ? ` • Fonte: ${t.source}` : ''}
                            ${t.isInstallment && t.installCount ? `(${t.installCount}x)` : ''}
                            ${t.isFixed ? '• Recorrente' : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4"><span class="font-bold ${t.type === 'entrada' ? 'text-emerald-600' : 'text-slate-800'}">${t.type === 'entrada' ? '+' : '-'} ${formatBRL(t.val)}</span></td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editTransaction(${t.id})" title="Editar" class="p-2 text-slate-400 hover:text-blue-600"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button onclick="deleteTransaction(${t.id})" title="Excluir" class="p-2 text-slate-400 hover:text-rose-600"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderStats(data) {
            const inVal = data.filter(t => t.type === 'entrada').reduce((a, b) => a + Number(b.val), 0);
            const outVal = data.filter(t => t.type === 'saida').reduce((a, b) => a + Number(b.val), 0);
            const balance = inVal - outVal;
            document.getElementById('totalIn').innerText = formatBRL(inVal);
            document.getElementById('totalOut').innerText = formatBRL(outVal);
            document.getElementById('totalBalance').innerText = formatBRL(balance);

            const goalValue = inVal / 3;
            const savings = balance;
            const progress = inVal > 0 ? Math.min((savings / goalValue) * 100, 100) : 0;
            const isAtRisk = inVal > 0 && savings < goalValue;

            const gp = document.getElementById('goalProgress');
            gp.style.width = `${Math.max(0, progress)}%`;
            document.getElementById('goalText').innerText = `Objetivo: Poupar ${formatBRL(goalValue)}`;
            
            const gs = document.getElementById('goalStatus');
            const gc = document.getElementById('goalCard');
            if (inVal === 0) {
                gs.innerText = "Aguardando Rendimento"; gs.className = "text-[10px] px-2 py-0.5 rounded-full font-bold bg-slate-100 text-slate-400";
                gc.style.borderColor = "#e2e8f0";
            } else if (isAtRisk) {
                gs.innerText = "Em Risco"; gs.className = "text-[10px] px-2 py-0.5 rounded-full font-bold bg-rose-100 text-rose-600";
                gc.style.borderColor = "#ef4444"; gp.className = "h-full bg-rose-500 transition-all";
            } else {
                gs.innerText = "No Caminho"; gs.className = "text-[10px] px-2 py-0.5 rounded-full font-bold bg-emerald-100 text-emerald-600";
                gc.style.borderColor = "#10b981"; gp.className = "h-full bg-emerald-500 transition-all";
            }
        }

        function renderChart(data) {
            const expenses = data.filter(t => t.type === 'saida');
            const totals = {}; expenses.forEach(t => totals[t.cat] = (totals[t.cat] || 0) + Number(t.val));
            const entries = Object.entries(totals);
            const container = document.getElementById('chartGraphic');
            const legend = document.getElementById('chartLegend');
            const empty = document.getElementById('emptyChart');
            const totalOut = expenses.reduce((a,b) => a + Number(b.val), 0);

            if (entries.length === 0) { container.classList.add('hidden'); legend.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden'); container.classList.remove('hidden');

            let offset = 0;
            document.getElementById('chartSlices').innerHTML = entries.map(([name, val], i) => {
                const percent = (val / totalOut) * 100;
                const dash = `${percent} ${100 - percent}`;
                const currentOffset = offset; offset += percent;
                return `<circle cx="18" cy="18" r="15.9" fill="transparent" stroke="${COLORS[i % COLORS.length]}" stroke-width="3" stroke-dasharray="${dash}" stroke-dashoffset="-${currentOffset}"></circle>`;
            }).join('');

            legend.innerHTML = entries.map(([name, val], i) => `
                <div class="flex items-center justify-between text-[11px]">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full" style="background-color: ${COLORS[i % COLORS.length]}"></div>
                        <span class="text-slate-600 font-medium">${name}</span>
                    </div>
                    <span class="font-bold text-slate-800">${formatBRL(val)}</span>
                </div>
            `).join('');
        }

        function exportToCSV() {
            let csv = 'Data,Descricao,Categoria,Metodo,Cartao,Fonte,Tipo,Valor,Fixo\n';
            transactions.forEach(t => {
                csv += `${t.date},${t.desc},${t.cat},${t.method},${t.cardUsed || ''},${t.source || ''},${t.type},${t.val},${t.isFixed?'Sim':'Não'}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', ''); a.setAttribute('href', url); a.setAttribute('download', 'meu_financeiro.csv');
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // Interações Básicas
        function changeMonth(offset) { currentMonth.setMonth(currentMonth.getMonth() + offset); render(); }
        
        function openModal() { 
            document.getElementById('editId').value = ''; 
            document.getElementById('financeForm').reset(); 
            document.getElementById('modalTitle').innerText = 'Nova Transação'; 
            document.getElementById('modalOverlay').classList.remove('hidden'); 
            setType('saida'); 
            handleRecurrence(null); 
            checkCreditMethod(); 
        }

        function closeModal() { document.getElementById('modalOverlay').classList.add('hidden'); }
        function deleteTransaction(id) { transactions = transactions.filter(t => t.id !== id); render(); }
        function formatBRL(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); }
        
        function setType(t, currentCat = null) { 
            currentType = t;
            const isEntry = t === 'entrada';
            
            // Toggle botões
            document.getElementById('btnSaida').className = t === 'saida' ? 'flex-1 py-2 rounded-lg text-sm font-bold bg-white text-rose-600 shadow-sm transition-all' : 'flex-1 py-2 rounded-lg text-sm font-bold text-slate-400';
            document.getElementById('btnEntrada').className = isEntry ? 'flex-1 py-2 rounded-lg text-sm font-bold bg-white text-emerald-600 shadow-sm transition-all' : 'flex-1 py-2 rounded-lg text-sm font-bold text-slate-400';
            
            // Toggle campos
            const sourceDiv = document.getElementById('sourceFieldDiv');
            const labelFixed = document.getElementById('labelFixed');
            const labelInstallment = document.getElementById('labelInstallment');
            
            if (isEntry) {
                sourceDiv.classList.remove('hidden');
                labelFixed.innerText = "Renda Recorrente?";
                labelInstallment.innerText = "Receb. Parcelado?";
                populateCategories(INCOME_CATEGORIES, currentCat);
            } else {
                sourceDiv.classList.add('hidden');
                labelFixed.innerText = "Despesa Fixa?";
                labelInstallment.innerText = "Parcelado?";
                populateCategories(EXPENSE_CATEGORIES, currentCat);
            }
        }

        function populateCategories(cats, selected = null) {
            const select = document.getElementById('cat');
            select.innerHTML = cats.map(c => `<option value="${c}" ${selected === c ? 'selected' : ''}>${c}</option>`).join('');
        }

        function handleRecurrence(mode) {
            const isInst = document.getElementById('isInstallment');
            const isFixed = document.getElementById('isFixed');
            
            if (mode === 'installment') {
                if (isInst.checked) isFixed.checked = false;
            } else if (mode === 'fixed') {
                if (isFixed.checked) isInst.checked = false;
            }

            document.getElementById('installmentFields').classList.toggle('hidden', !isInst.checked);
            document.getElementById('fixedFields').classList.toggle('hidden', !isFixed.checked);
            updateLastInstallment();
        }

        function checkCreditMethod() {
            const method = document.getElementById('method').value;
            const cardDiv = document.getElementById('cardSelectorDiv');
            if (method === 'Crédito') cardDiv.classList.remove('hidden');
            else { cardDiv.classList.add('hidden'); document.getElementById('cardUsed').value = ""; }
        }

        function updateLastInstallment() {
            const dateStr = document.getElementById('date').value;
            const count = parseInt(document.getElementById('installCount').value) || 1;
            if (!dateStr) return;
            const d = new Date(dateStr + 'T12:00:00');
            d.setMonth(d.getMonth() + (count - 1));
            document.getElementById('lastInstallLabel').innerText = d.toLocaleDateString('pt-BR');
        }

        function editTransaction(id) {
            const t = transactions.find(x => x.id === id);
            if (!t) return;
            document.getElementById('editId').value = t.id;
            document.getElementById('desc').value = t.desc;
            document.getElementById('val').value = t.val;
            document.getElementById('date').value = t.date;
            document.getElementById('method').value = t.method;
            document.getElementById('source').value = t.source || "";
            document.getElementById('cardUsed').value = t.cardUsed || "";
            document.getElementById('isInstallment').checked = t.isInstallment;
            document.getElementById('isFixed').checked = t.isFixed;
            document.getElementById('installCount').value = t.installCount || 2;
            document.getElementById('fixedDuration').value = t.fixedDuration || 12;
            
            setType(t.type, t.cat);
            handleRecurrence(t.isFixed ? 'fixed' : (t.isInstallment ? 'installment' : null));
            checkCreditMethod();
            
            document.getElementById('modalTitle').innerText = 'Editar Lançamento';
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        document.getElementById('financeForm').onsubmit = function(e) {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            
            const baseDesc = document.getElementById('desc').value;
            const source = document.getElementById('source').value;
            const val = parseFloat(document.getElementById('val').value);
            const date = document.getElementById('date').value;
            const cat = document.getElementById('cat').value;
            const method = document.getElementById('method').value;
            const cardUsed = document.getElementById('cardUsed').value;
            const isInstallment = document.getElementById('isInstallment').checked;
            const isFixed = document.getElementById('isFixed').checked;
            const installCount = parseInt(document.getElementById('installCount').value) || 1;
            const fixedDuration = parseInt(document.getElementById('fixedDuration').value) || 12;

            if (editId) {
                // Edição de uma ocorrência específica
                transactions = transactions.map(t => t.id === parseInt(editId) ? {
                    ...t, desc: baseDesc, source, val, date, cat, method, cardUsed, type: currentType
                } : t);
            } else if (isInstallment) {
                const baseDate = new Date(date + 'T12:00:00');
                const groupId = Date.now();
                for (let i = 0; i < installCount; i++) {
                    const d = new Date(baseDate); d.setMonth(baseDate.getMonth() + i);
                    transactions.push({
                        id: groupId + i, desc: `${baseDesc} (${i + 1}/${installCount})`, val,
                        date: d.toISOString().split('T')[0], cat, method, cardUsed, source, type: currentType,
                        isInstallment: true, installCount, installGroupId: groupId
                    });
                }
            } else if (isFixed) {
                // Geração de lançamento fixo com duração customizada
                const baseDate = new Date(date + 'T12:00:00');
                const groupId = Date.now();
                for (let i = 0; i < fixedDuration; i++) {
                    const d = new Date(baseDate); d.setMonth(baseDate.getMonth() + i);
                    transactions.push({
                        id: groupId + i, desc: baseDesc, val,
                        date: d.toISOString().split('T')[0], cat, method, cardUsed, source, type: currentType,
                        isFixed: true, fixedDuration, fixedGroupId: groupId
                    });
                }
            } else {
                transactions.push({
                    id: Date.now(), desc: baseDesc, source, val, date, cat, method, cardUsed, type: currentType,
                    isInstallment: false, isFixed: false
                });
            }

            closeModal();
            render();
        }

        init();
    </script>
</body>
</html>
