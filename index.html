<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance Pro - Gestão Financeira</title>
    <!-- Tailwind CSS para um design limpo e moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        /* Personalização da barra de scroll para o modal */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-12 text-slate-900 text-[13px]">

    <!-- Cabeçalho Principal -->
    <header class="bg-white border-b sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <span class="bg-blue-600 text-white p-1.5 rounded-lg shadow-md">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                </span>
                MyFinance
            </h1>
            <!-- Navegação de Meses -->
            <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-xl ring-1 ring-slate-200">
                <button onclick="changeMonth(-1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition-all active:scale-90">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m15 18-6-6 6-6"></path></svg>
                </button>
                <div class="flex items-center gap-1 px-2">
                    <select id="selectMonth" onchange="jumpToDate()" class="bg-transparent font-semibold text-slate-600 outline-none cursor-pointer">
                        <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Março</option>
                        <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
                        <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
                        <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                    </select>
                    <input type="number" id="selectYear" onchange="jumpToDate()" class="bg-transparent font-semibold text-slate-600 w-14 outline-none cursor-pointer" value="2024">
                </div>
                <button onclick="changeMonth(1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition-all active:scale-90">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m9 18 6-6-6-6"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 mb-8">
            <div class="bg-white p-4 rounded-2xl border shadow-sm ring-1 ring-slate-100">
                <p class="text-slate-500 text-[10px] font-bold uppercase mb-1 tracking-wider">Saldo Geral</p>
                <h3 id="totalBalance" class="text-lg font-bold text-slate-800 tabular-nums">R$ 0,00</h3>
                <p class="text-[9px] text-slate-400 mt-1">Total em conta + Flash</p>
            </div>
            <div class="bg-white p-4 rounded-2xl border shadow-sm ring-1 ring-blue-50 border-l-4 border-l-blue-500">
                <p class="text-blue-600 text-[10px] font-bold uppercase mb-1 tracking-wider">Saldo Flash</p>
                <h3 id="flashBalance" class="text-lg font-bold text-blue-700 tabular-nums">R$ 0,00</h3>
                <p class="text-[9px] text-slate-400 mt-1">Exclusivo benefícios</p>
            </div>
            <div class="bg-white p-4 rounded-2xl border shadow-sm ring-1 ring-emerald-50">
                <p class="text-emerald-600 text-[10px] font-bold uppercase mb-1 tracking-wider">Entradas</p>
                <h3 id="totalIn" class="text-lg font-bold text-emerald-600 tabular-nums">R$ 0,00</h3>
            </div>
            <div class="bg-white p-4 rounded-2xl border shadow-sm ring-1 ring-amber-50">
                <p class="text-amber-500 text-[10px] font-bold uppercase mb-1 tracking-wider">A receber</p>
                <h3 id="totalPendingIn" class="text-lg font-bold text-amber-600 tabular-nums">R$ 0,00</h3>
            </div>
            <div class="bg-white p-4 rounded-2xl border shadow-sm ring-1 ring-rose-50">
                <p class="text-rose-500 text-[10px] font-bold uppercase mb-1 tracking-wider">Saídas</p>
                <h3 id="totalOut" class="text-lg font-bold text-rose-600 tabular-nums">R$ 0,00</h3>
            </div>
            <!-- Meta -->
            <div id="goalCard" class="bg-white p-4 rounded-2xl border shadow-sm flex flex-col justify-between border-l-4 ring-1 ring-blue-50">
                <div class="flex items-center justify-between mb-1">
                    <p class="text-blue-600 text-[10px] font-bold uppercase tracking-wider">Meta (1/3)</p>
                    <span id="goalStatus" class="text-[9px] px-1.5 py-0.5 rounded-full font-bold uppercase"></span>
                </div>
                <div class="space-y-1">
                    <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden shadow-inner">
                        <div id="goalProgress" class="h-full bg-blue-500 transition-all duration-700"></div>
                    </div>
                    <p id="goalText" class="text-[9px] text-slate-400 mt-1"></p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <!-- Ações -->
                <div class="flex flex-wrap gap-4">
                    <button onclick="openModal()" class="flex-1 min-w-[200px] py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-bold shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2 group active:scale-95">
                        <svg class="group-hover:rotate-90 transition-transform duration-300" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
                        Novo Lançamento
                    </button>
                    
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button onclick="exportToCSV()" class="flex-1 px-4 py-4 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 text-sm shadow-sm active:scale-95">
                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"></path></svg>
                            Exportar
                        </button>
                        
                        <button onclick="triggerImport()" class="flex-1 px-4 py-4 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 text-sm shadow-sm active:scale-95">
                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"></path></svg>
                            Importar
                        </button>
                        <input type="file" id="csvFileInput" class="hidden" accept=".csv" onchange="handleImport(event)">
                    </div>
                </div>

                <!-- Barra de Filtros / Busca -->
                <div class="bg-white p-4 rounded-2xl border shadow-sm ring-1 ring-slate-100 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="relative">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-tight">Buscar por Texto ou Valor</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-3 flex items-center text-slate-400">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                            </span>
                            <input type="text" id="searchFilter" oninput="render()" class="w-full pl-9 pr-4 py-2 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Descrição ou valor...">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-tight">Categoria</label>
                        <select id="catFilter" onchange="render()" class="w-full px-4 py-2 border border-slate-200 rounded-xl outline-none bg-white focus:ring-2 focus:ring-blue-500">
                            <option value="">Todas as Categorias</option>
                            <optgroup id="expGroupFilter" label="Despesas"></optgroup>
                            <optgroup id="incGroupFilter" label="Receitas"></optgroup>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-tight">Forma de Pagamento</label>
                        <select id="methodFilter" onchange="render()" class="w-full px-4 py-2 border border-slate-200 rounded-xl outline-none bg-white focus:ring-2 focus:ring-blue-500">
                            <option value="">Todas as Formas</option>
                            <option>Pix</option><option>Pix Agendado</option><option>Pix Automático</option>
                            <option>Crédito</option><option>Débito</option><option>Boleto</option>
                            <option>Dinheiro</option><option>Desconto em Folha</option><option value="Flash">Cartão Flash</option>
                        </select>
                    </div>
                </div>

                <!-- Histórico -->
                <div class="bg-white rounded-2xl border shadow-sm overflow-hidden ring-1 ring-slate-100">
                    <div class="p-5 border-b bg-slate-50/50 flex items-center justify-between">
                        <h2 class="font-bold text-slate-800 tracking-tight text-base uppercase text-[12px]">Extrato de Competência</h2>
                        <span id="filteredCount" class="text-[10px] font-bold bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full"></span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-500 text-[11px] uppercase tracking-wider font-semibold border-b">
                                <tr>
                                    <th class="px-6 py-4 text-center">Data</th>
                                    <th class="px-6 py-4">Detalhes</th>
                                    <th class="px-6 py-4 text-center">Competência</th>
                                    <th class="px-8 py-4 text-right">Valor</th>
                                    <th class="px-6 py-4 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="transactionBody" class="divide-y text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Coluna Lateral -->
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-2xl border shadow-sm ring-1 ring-slate-100">
                    <h2 class="font-bold text-slate-800 mb-6 border-b pb-2 tracking-tight text-base">Gastos por Categoria</h2>
                    <div id="chartContainer" class="flex flex-col items-center">
                        <div id="emptyChart" class="py-12 text-center text-slate-400 text-sm italic">Sem gastos registados.</div>
                        <div id="chartGraphic" class="hidden relative w-48 h-48 mb-6">
                            <svg viewBox="0 0 36 36" class="w-full h-full transform -rotate-90">
                                <circle cx="18" cy="18" r="15.9" fill="transparent" stroke="#f3f4f6" stroke-width="3"></circle>
                                <g id="chartSlices"></g>
                            </svg>
                        </div>
                        <div id="chartLegend" class="w-full space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Formulário -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="px-6 py-4 border-b bg-slate-50 flex items-center justify-between">
                <h3 id="modalTitle" class="font-bold text-slate-800">Novo Lançamento</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <form id="financeForm" class="p-6 space-y-4 max-h-[85vh] overflow-y-auto custom-scrollbar">
                <input type="hidden" id="editId">
                
                <div class="flex bg-slate-100 p-1 rounded-xl ring-1 ring-slate-200">
                    <button type="button" onclick="setType('saida')" id="btnSaida" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white text-rose-600 shadow-sm transition-all">Saída</button>
                    <button type="button" onclick="setType('entrada')" id="btnEntrada" class="flex-1 py-2 rounded-lg text-sm font-bold text-slate-400 transition-all">Entrada</button>
                </div>

                <div id="incomeStatusDiv" class="hidden grid grid-cols-2 gap-2 bg-emerald-50 p-1 rounded-xl ring-1 ring-emerald-100 shadow-inner">
                    <button type="button" onclick="setIncomeStatus('recebido')" id="btnRecebido" class="flex-1 py-1.5 rounded-lg text-xs font-bold bg-emerald-600 text-white shadow-sm transition-all">Recebido</button>
                    <button type="button" onclick="setIncomeStatus('a_receber')" id="btnAReceber" class="flex-1 py-1.5 rounded-lg text-xs font-bold text-emerald-600 transition-all">A receber</button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-[11px] font-bold text-slate-500 mb-1 uppercase tracking-tighter">Descrição</label>
                        <input type="text" id="desc" required class="w-full px-4 py-2.5 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Ex: Mercado, Flash Mensal...">
                    </div>
                    
                    <div id="sourceFieldDiv" class="col-span-2 hidden animate-in slide-in-from-top-2">
                        <label class="block text-[11px] font-bold text-emerald-600 mb-1 uppercase tracking-tighter">Fonte (Quem pagou?)</label>
                        <input type="text" id="source" class="w-full px-4 py-2.5 border border-emerald-200 rounded-xl outline-none bg-emerald-50/50 focus:ring-2 focus:ring-emerald-500" placeholder="Ex: Minha Empresa...">
                    </div>

                    <div id="invoiceSectionDiv" class="col-span-2 hidden space-y-3 animate-in slide-in-from-top-1">
                        <label class="flex items-center gap-2 cursor-pointer bg-emerald-50/50 p-3 rounded-xl border border-emerald-100 hover:bg-emerald-100/50 transition-colors shadow-sm">
                            <input type="checkbox" id="isInvoiceSent" onchange="toggleInvoiceDate()" class="w-4 h-4 text-emerald-600 rounded">
                            <span class="text-[11px] font-bold text-emerald-700 uppercase tracking-tighter">Nota Fiscal já foi enviada?</span>
                        </label>
                        <div id="invoiceDateDiv" class="hidden">
                            <label class="block text-[10px] font-bold text-emerald-500 mb-1 uppercase tracking-tighter">Data de Envio da NF</label>
                            <input type="date" id="invoiceDate" class="w-full px-4 py-2 bg-white border border-emerald-100 rounded-xl outline-none">
                        </div>
                    </div>

                    <div><label class="block text-[11px] font-bold text-slate-500 mb-1 uppercase tracking-tighter">Valor (R$)</label><input type="number" step="0.01" id="val" required class="w-full px-4 py-2.5 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="0,00"></div>
                    <div><label class="block text-[11px] font-bold text-slate-500 mb-1 uppercase tracking-tighter">Data</label><input type="date" id="date" required class="w-full px-4 py-2.5 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" onchange="updateLastInstallment()"></div>
                    
                    <div>
                        <label class="block text-[11px] font-bold text-slate-500 mb-1 uppercase tracking-tighter">Categoria</label>
                        <select id="cat" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl outline-none bg-white focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                    <div>
                        <label class="block text-[11px] font-bold text-slate-500 mb-1 uppercase tracking-tighter">Forma de Pagamento</label>
                        <select id="method" onchange="checkCreditMethod()" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl outline-none bg-white focus:ring-2 focus:ring-blue-500">
                            <option>Pix</option>
                            <option>Pix Agendado</option>
                            <option>Pix Automático</option>
                            <option>Crédito</option>
                            <option>Débito</option>
                            <option>Boleto</option>
                            <option>Dinheiro</option>
                            <option>Desconto em Folha</option>
                            <option value="Flash">Cartão Flash</option>
                        </select>
                    </div>

                    <div id="cardSelectorDiv" class="col-span-2 hidden animate-in slide-in-from-top-2">
                        <label class="block text-[11px] font-bold text-blue-500 mb-1 uppercase tracking-tighter">Cartão Utilizado</label>
                        <select id="cardUsed" class="w-full px-4 py-2.5 border border-blue-200 rounded-xl outline-none bg-blue-50 shadow-sm focus:ring-2 focus:ring-blue-400">
                            <option value="">Selecione o cartão...</option>
                            <option>BTG</option>
                            <option>Pão de açúcar (cancelado)</option>
                            <option>Inter</option>
                            <option>Flash</option>
                        </select>
                    </div>
                </div>

                <div id="recurrenceDiv" class="bg-slate-50 p-4 rounded-2xl border border-slate-200 space-y-3 shadow-inner ring-1 ring-slate-200/50">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="isInstallment" onchange="handleRecurrence('installment')" class="w-4 h-4 text-blue-600 rounded">
                            <span id="labelInstallment" class="text-[11px] font-bold text-slate-700">Parcelado?</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="isFixed" onchange="handleRecurrence('fixed')" class="w-4 h-4 text-emerald-600 rounded">
                            <span id="labelFixed" class="text-[11px] font-bold text-slate-700">Fixo?</span>
                        </label>
                    </div>

                    <div id="installmentFields" class="hidden grid grid-cols-2 gap-4 animate-in slide-in-from-top-1">
                        <div><label class="block text-[10px] font-bold text-blue-400 mb-1 uppercase tracking-tighter">Qtd Parcelas</label><input type="number" id="installCount" min="2" value="2" oninput="updateLastInstallment()" class="w-full px-3 py-1.5 border border-blue-100 rounded-lg outline-none"></div>
                        <div><label class="block text-[10px] font-bold text-blue-400 mb-1 uppercase tracking-tighter">Última Parcela</label><div id="lastInstallLabel" class="text-sm font-bold text-blue-700 py-1.5">—</div></div>
                    </div>
                    <div id="fixedFields" class="hidden grid grid-cols-2 gap-4 animate-in slide-in-from-top-1 items-end">
                        <div><label class="block text-[10px] font-bold text-emerald-500 mb-1 uppercase tracking-tighter">Duração (meses)</label><input type="number" id="fixedDuration" min="1" value="12" class="w-full px-3 py-1.5 border border-emerald-100 rounded-lg outline-none"></div>
                        <div class="text-[9px] text-emerald-600 font-medium leading-tight pb-1 italic">Repetir mensalmente.</div>
                    </div>
                </div>

                <button type="submit" class="w-full py-4 bg-slate-800 hover:bg-black text-white rounded-xl font-bold transition-all shadow-xl active:scale-95">Guardar Alterações</button>
            </form>
        </div>
    </div>

    <script>
        // --- Categorias e Configurações ---
        const EXPENSE_CATEGORIES = ['Alimentação', 'Moradia', 'Combustível', 'Manutenção carro', 'Lazer', 'Saúde', 'Pets', 'Educação', 'Manutenção casa', 'Vestuário', 'Cosméticos', 'Eletrônicos', 'Presentes', 'Transporte', 'Farmácia'];
        const INCOME_CATEGORIES = ['Salário', 'Freelance', 'Presentes', 'Vale Alimentação'];

        // --- Gestão de Dados ---
        const STORAGE_KEY = 'myfinance_v15_fixed_btg_logic'; 
        let transactions = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

        function saveToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions)); }

        // --- Estado Global ---
        let currentMonth = new Date();
        let currentType = 'saida';
        let currentIncomeStatus = 'recebido';
        const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#71717a'];

        // --- Lógica de Competência (Fechamento Fatura) ---
        function getCompetencia(dateStr, method, card) {
            const d = new Date(dateStr + 'T12:00:00');
            let m = d.getMonth();
            let y = d.getFullYear();

            // Regra BTG: Fechamento dia 12. 
            // Compras no Crédito BTG após dia 12 caem no próximo mês.
            if (method === 'Crédito' && card === 'BTG' && d.getDate() > 12) {
                m++;
                if (m > 11) { m = 0; y++; }
            }
            return { month: m, year: y };
        }

        function init() { 
            populateFilterCategories();
            render(); 
            updateLastInstallment(); 
        }

        function populateFilterCategories() {
            const expGroup = document.getElementById('expGroupFilter');
            const incGroup = document.getElementById('incGroupFilter');
            expGroup.innerHTML = EXPENSE_CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
            incGroup.innerHTML = INCOME_CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function jumpToDate() {
            const m = parseInt(document.getElementById('selectMonth').value);
            const y = parseInt(document.getElementById('selectYear').value);
            currentMonth = new Date(y, m, 1);
            render();
        }

        function render() {
            updateLabels();
            const filtered = getFilteredData();
            renderTable(filtered);
            renderStats(filtered);
            renderChart(filtered);
            saveToStorage();
        }

        function updateLabels() {
            const m = currentMonth.getMonth();
            const y = currentMonth.getFullYear();
            document.getElementById('selectMonth').value = m;
            document.getElementById('selectYear').value = y;
            
            if(!document.getElementById('editId').value) {
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
            }
        }

        function getFilteredData() {
            const searchText = document.getElementById('searchFilter').value.toLowerCase();
            const catFilter = document.getElementById('catFilter').value;
            const methodFilter = document.getElementById('methodFilter').value;

            const baseData = transactions.filter(t => {
                // Filtro Base: Mês de Competência
                const comp = getCompetencia(t.date, t.method, t.cardUsed);
                const isMatchMonth = comp.month === currentMonth.getMonth() && comp.year === currentMonth.getFullYear();
                if (!isMatchMonth) return false;

                // Sub-filtros: Busca, Categoria e Método
                const matchesSearch = t.desc.toLowerCase().includes(searchText) || t.val.toString().includes(searchText);
                const matchesCat = catFilter === "" || t.cat === catFilter;
                const matchesMethod = methodFilter === "" || t.method === methodFilter;

                return matchesSearch && matchesCat && matchesMethod;
            });

            document.getElementById('filteredCount').innerText = `${baseData.length} registros`;
            return baseData;
        }

        function renderTable(data) {
            const body = document.getElementById('transactionBody');
            if (data.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 italic">Nenhum lançamento encontrado para os filtros ativos.</td></tr>';
                return;
            }
            body.innerHTML = data.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => {
                const isNextBill = t.method === 'Crédito' && t.cardUsed === 'BTG' && new Date(t.date + 'T12:00:00').getDate() > 12;
                
                return `
                <tr class="hover:bg-slate-50 transition-colors group">
                    <td class="px-6 py-4 text-slate-500 whitespace-nowrap tabular-nums text-center font-medium">${t.date.split('-').reverse().join('/')}</td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-slate-700 flex flex-wrap items-center gap-1.5 leading-tight">
                            ${t.desc}
                            ${t.isFixed ? '<span title="Recorrente" class="text-emerald-500"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></span>' : ''}
                            ${t.type === 'entrada' ? `<span class="text-[8px] px-1.5 py-0.5 rounded-full font-black shadow-sm ${t.status === 'recebido' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${t.status === 'recebido' ? 'RECEBIDO' : 'A RECEBER'}</span>` : ''}
                        </div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold flex flex-wrap items-center gap-1.5 mt-0.5 tracking-tight">
                            ${t.cat} • ${t.method}${t.cardUsed ? ` (${t.cardUsed})` : ''} 
                            ${t.source ? ` • Fonte: ${t.source}` : ''}
                            ${t.isInvoiceSent ? `<span class="bg-blue-50 text-blue-600 px-1 rounded text-[8px]">NF ENVIADA</span>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="text-[9px] font-black px-2 py-0.5 rounded-lg border flex items-center justify-center gap-1 w-fit mx-auto ${isNextBill ? 'bg-amber-50 text-amber-600 border-amber-200' : 'bg-blue-50 text-blue-600 border-blue-200'}">
                            ${isNextBill ? 'PRÓX. FATURA' : 'ATUAL'}
                        </span>
                    </td>
                    <td class="px-8 py-4 text-right"><span class="font-bold tabular-nums ${t.type === 'entrada' ? 'text-emerald-600' : 'text-slate-800'} ${t.type === 'entrada' && t.status === 'a_receber' ? 'opacity-40' : ''}">
                        ${t.type === 'entrada' ? '+' : '-'} ${formatBRL(t.val)}
                    </span></td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editTransaction(${t.id})" class="p-2 text-slate-400 hover:text-blue-600 transition-colors"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button onclick="deleteTransaction(${t.id})" class="p-2 text-slate-400 hover:text-rose-600 transition-colors"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function renderStats(data) {
            // Lógica de segregação Flash baseada nos dados filtrados
            const inReceived = data.filter(t => t.type === 'entrada' && t.status === 'recebido').reduce((a, b) => a + Number(b.val), 0);
            const outTotal = data.filter(t => t.type === 'saida').reduce((a, b) => a + Number(b.val), 0);
            
            const flashIn = data.filter(t => t.type === 'entrada' && t.status === 'recebido' && (t.method === 'Flash' || t.cardUsed === 'Flash')).reduce((a, b) => a + Number(b.val), 0);
            const flashOut = data.filter(t => t.type === 'saida' && (t.method === 'Flash' || t.cardUsed === 'Flash')).reduce((a, b) => a + Number(b.val), 0);
            const flashBalanceVal = flashIn - flashOut;

            const inPending = data.filter(t => t.type === 'entrada' && t.status === 'a_receber').reduce((a, b) => a + Number(b.val), 0);
            const balance = inReceived - outTotal;
            
            document.getElementById('totalIn').innerText = formatBRL(inReceived);
            document.getElementById('totalPendingIn').innerText = formatBRL(inPending);
            document.getElementById('totalOut').innerText = formatBRL(outTotal);
            document.getElementById('totalBalance').innerText = formatBRL(balance);
            document.getElementById('flashBalance').innerText = formatBRL(flashBalanceVal);

            const goalValue = inReceived / 3;
            const progress = inReceived > 0 ? Math.min((balance / goalValue) * 100, 100) : 0;
            const isAtRisk = inReceived > 0 && balance < goalValue;

            const gp = document.getElementById('goalProgress');
            gp.style.width = `${Math.max(0, progress)}%`;
            document.getElementById('goalText').innerText = `Alvo: ${formatBRL(goalValue)}`;
            
            const gs = document.getElementById('goalStatus');
            const gc = document.getElementById('goalCard');
            if (inReceived === 0) {
                gs.innerText = "S/ Dados"; gs.className = "text-[9px] px-1.5 py-0.5 rounded-full font-bold bg-slate-100 text-slate-400 uppercase tracking-tighter";
                gc.style.borderColor = "#e2e8f0";
            } else if (isAtRisk) {
                gs.innerText = "Em Risco"; gs.className = "text-[9px] px-1.5 py-0.5 rounded-full font-bold bg-rose-100 text-rose-600 uppercase tracking-tighter";
                gc.style.borderColor = "#ef4444"; gp.className = "h-full bg-rose-500 transition-all";
            } else {
                gs.innerText = "OK"; gs.className = "text-[9px] px-1.5 py-0.5 rounded-full font-bold bg-emerald-100 text-emerald-700 uppercase tracking-tighter";
                gc.style.borderColor = "#10b981"; gp.className = "h-full bg-emerald-500 transition-all";
            }
        }

        function renderChart(data) {
            const expenses = data.filter(t => t.type === 'saida');
            const totals = {}; expenses.forEach(t => totals[t.cat] = (totals[t.cat] || 0) + Number(t.val));
            const entries = Object.entries(totals);
            const container = document.getElementById('chartGraphic');
            const legend = document.getElementById('chartLegend');
            const empty = document.getElementById('emptyChart');
            const totalOut = expenses.reduce((a,b) => a + Number(b.val), 0);

            if (entries.length === 0) { container.classList.add('hidden'); legend.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden'); container.classList.remove('hidden');

            let offset = 0;
            document.getElementById('chartSlices').innerHTML = entries.map(([name, val], i) => {
                const percent = (val / totalOut) * 100;
                const dash = `${percent} ${100 - percent}`;
                const currentOffset = offset; offset += percent;
                return `<circle cx="18" cy="18" r="15.9" fill="transparent" stroke="${COLORS[i % COLORS.length]}" stroke-width="3.5" stroke-dasharray="${dash}" stroke-dashoffset="-${currentOffset}"></circle>`;
            }).join('');

            legend.innerHTML = entries.map(([name, val], i) => `
                <div class="flex items-center justify-between text-[11px] py-0.5 animate-in fade-in slide-in-from-left-1 border-b border-slate-50 last:border-0">
                    <div class="flex items-center gap-2">
                        <div class="w-2.5 h-2.5 rounded-full shadow-sm" style="background-color: ${COLORS[i % COLORS.length]}"></div>
                        <span class="text-slate-600 font-medium">${name}</span>
                    </div>
                    <span class="font-bold text-slate-800 tabular-nums">${formatBRL(val)}</span>
                </div>
            `).join('');
        }

        // --- Backup e Importação ---
        function exportToCSV() {
            let csv = 'Data,Descricao,Categoria,Metodo,Cartao,Fonte,Status,Tipo,Valor,NF_Enviada,NF_Data,IsFixed,FixedDuration,IsInstallment,InstallCount\n';
            transactions.forEach(t => {
                csv += `${t.date},"${t.desc}","${t.cat}","${t.method}","${t.cardUsed || ''}","${t.source || ''}","${t.status || ''}","${t.type}",${t.val},${t.isInvoiceSent ? 1 : 0},"${t.invoiceDate || ''}",${t.isFixed ? 1 : 0},${t.fixedDuration || 0},${t.isInstallment ? 1 : 0},${t.installCount || 0}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', ''); a.setAttribute('href', url); a.setAttribute('download', `backup_financeiro_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function triggerImport() { document.getElementById('csvFileInput').click(); }

        function handleImport(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result; const rows = text.split('\n').slice(1); const newTransactions = [];
                rows.forEach((row, index) => {
                    if (!row.trim()) return;
                    const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    const clean = cols.map(c => c.replace(/^"|"$/g, ''));
                    if (clean.length >= 9) {
                        newTransactions.push({
                            id: Date.now() + index, date: clean[0], desc: clean[1], cat: clean[2], method: clean[3], cardUsed: clean[4], source: clean[5], status: clean[6], type: clean[7], val: parseFloat(clean[8]), isInvoiceSent: clean[9] === '1', invoiceDate: clean[10], isFixed: clean[11] === '1', fixedDuration: parseInt(clean[12] || 0), isInstallment: clean[13] === '1', installCount: parseInt(clean[14] || 0)
                        });
                    }
                });
                if (newTransactions.length > 0 && confirm(`Importar ${newTransactions.length} registos?`)) { transactions = [...transactions, ...newTransactions]; render(); }
            };
            reader.readAsText(file); event.target.value = '';
        }

        // --- UI Logica ---
        function changeMonth(offset) { 
            currentMonth.setMonth(currentMonth.getMonth() + offset); 
            render(); 
        }
        function closeModal() { document.getElementById('modalOverlay').classList.add('hidden'); }
        function openModal() { document.getElementById('editId').value = ''; document.getElementById('financeForm').reset(); document.getElementById('modalOverlay').classList.remove('hidden'); setType('saida'); handleRecurrence(null); checkCreditMethod(); }
        function deleteTransaction(id) { if(confirm("Eliminar definitivamente?")) { transactions = transactions.filter(t => t.id !== id); render(); } }
        function formatBRL(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); }
        
        function setType(t, currentCat = null) { 
            currentType = t;
            const isEntry = t === 'entrada';
            document.getElementById('btnSaida').className = t === 'saida' ? 'flex-1 py-2 rounded-lg text-sm font-bold bg-white text-rose-600 shadow-sm transition-all' : 'flex-1 py-2 rounded-lg text-sm font-bold text-slate-400 transition-all';
            document.getElementById('btnEntrada').className = isEntry ? 'flex-1 py-2 rounded-lg text-sm font-bold bg-white text-emerald-600 shadow-sm transition-all' : 'flex-1 py-2 rounded-lg text-sm font-bold text-slate-400 transition-all';
            const sourceDiv = document.getElementById('sourceFieldDiv');
            const incomeStatusDiv = document.getElementById('incomeStatusDiv');
            if (isEntry) {
                sourceDiv.classList.remove('hidden'); incomeStatusDiv.classList.remove('hidden');
                setIncomeStatus(currentIncomeStatus); populateCategories(INCOME_CATEGORIES, currentCat);
            } else {
                sourceDiv.classList.add('hidden'); incomeStatusDiv.classList.add('hidden');
                document.getElementById('invoiceSectionDiv').classList.add('hidden');
                populateCategories(EXPENSE_CATEGORIES, currentCat);
            }
        }

        function setIncomeStatus(status) {
            currentIncomeStatus = status;
            const isRec = status === 'recebido';
            document.getElementById('btnRecebido').className = isRec ? 'flex-1 py-1.5 rounded-lg text-xs font-bold bg-emerald-600 text-white shadow-sm transition-all' : 'flex-1 py-1.5 rounded-lg text-xs font-bold text-emerald-600 transition-all';
            document.getElementById('btnAReceber').className = !isRec ? 'flex-1 py-1.5 rounded-lg text-xs font-bold bg-emerald-600 text-white shadow-sm transition-all' : 'flex-1 py-1.5 rounded-lg text-xs font-bold text-emerald-600 transition-all';
            const invoiceDiv = document.getElementById('invoiceSectionDiv');
            if (status === 'a_receber') invoiceDiv.classList.remove('hidden'); else invoiceDiv.classList.add('hidden');
            toggleInvoiceDate();
        }

        function toggleInvoiceDate() {
            const isSent = document.getElementById('isInvoiceSent').checked;
            const dateDiv = document.getElementById('invoiceDateDiv');
            if (currentIncomeStatus === 'a_receber' && isSent) dateDiv.classList.remove('hidden'); else dateDiv.classList.add('hidden');
        }

        function populateCategories(cats, selected = null) {
            const select = document.getElementById('cat');
            select.innerHTML = cats.map(c => `<option value="${c}" ${selected === c ? 'selected' : ''}>${c}</option>`).join('');
        }

        function handleRecurrence(mode) {
            const isInst = document.getElementById('isInstallment');
            const isFixed = document.getElementById('isFixed');
            if (mode === 'installment' && isInst.checked) isFixed.checked = false;
            else if (mode === 'fixed' && isFixed.checked) isInst.checked = false;
            document.getElementById('installmentFields').classList.toggle('hidden', !isInst.checked);
            document.getElementById('fixedFields').classList.toggle('hidden', !isFixed.checked);
            updateLastInstallment();
        }

        function checkCreditMethod() {
            const method = document.getElementById('method').value;
            const cardDiv = document.getElementById('cardSelectorDiv');
            if (method === 'Crédito' || method === 'Flash') cardDiv.classList.remove('hidden');
            else { cardDiv.classList.add('hidden'); document.getElementById('cardUsed').value = ""; }
        }

        function updateLastInstallment() {
            const dateStr = document.getElementById('date').value;
            const count = parseInt(document.getElementById('installCount').value) || 1;
            if (!dateStr) return;
            const d = new Date(dateStr + 'T12:00:00'); d.setMonth(d.getMonth() + (count - 1));
            document.getElementById('lastInstallLabel').innerText = d.toLocaleDateString('pt-BR');
        }

        function editTransaction(id) {
            const t = transactions.find(x => x.id === id); if (!t) return;
            document.getElementById('editId').value = t.id;
            document.getElementById('desc').value = t.desc;
            document.getElementById('val').value = t.val;
            document.getElementById('date').value = t.date;
            document.getElementById('method').value = t.method;
            document.getElementById('source').value = t.source || "";
            document.getElementById('isInvoiceSent').checked = t.isInvoiceSent || false;
            document.getElementById('invoiceDate').value = t.invoiceDate || "";
            document.getElementById('cardUsed').value = t.cardUsed || "";
            document.getElementById('isInstallment').checked = t.isInstallment;
            document.getElementById('isFixed').checked = t.isFixed;
            document.getElementById('installCount').value = t.installCount || 2;
            document.getElementById('fixedDuration').value = t.fixedDuration || 12;
            if (t.type === 'entrada') currentIncomeStatus = t.status || 'recebido';
            setType(t.type, t.cat); handleRecurrence(t.isFixed ? 'fixed' : (t.isInstallment ? 'installment' : null));
            checkCreditMethod(); document.getElementById('modalOverlay').classList.remove('hidden');
        }

        document.getElementById('financeForm').onsubmit = function(e) {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            const baseDesc = document.getElementById('desc').value;
            const source = document.getElementById('source').value;
            const isInvoiceSent = currentType === 'entrada' && currentIncomeStatus === 'a_receber' ? document.getElementById('isInvoiceSent').checked : false;
            const invoiceDate = isInvoiceSent ? document.getElementById('invoiceDate').value : "";
            const val = parseFloat(document.getElementById('val').value);
            const date = document.getElementById('date').value;
            const cat = document.getElementById('cat').value;
            const method = document.getElementById('method').value;
            const cardUsed = document.getElementById('cardUsed').value;
            const isInstallment = document.getElementById('isInstallment').checked;
            const isFixed = document.getElementById('isFixed').checked;
            const installCount = parseInt(document.getElementById('installCount').value) || 1;
            const fixedDuration = parseInt(document.getElementById('fixedDuration').value) || 12;

            const baseData = { desc: baseDesc, source, isInvoiceSent, invoiceDate, val, date, cat, method, cardUsed, type: currentType, status: currentType === 'entrada' ? currentIncomeStatus : 'pago' };

            if (editId) {
                transactions = transactions.map(t => t.id === parseInt(editId) ? { ...t, ...baseData } : t);
            } else if (isInstallment) {
                const baseDate = new Date(date + 'T12:00:00');
                const groupId = Date.now();
                for (let i = 0; i < installCount; i++) {
                    const d = new Date(baseDate); d.setMonth(baseDate.getMonth() + i);
                    transactions.push({ ...baseData, id: groupId + i, desc: `${baseDesc} (${i + 1}/${installCount})`, date: d.toISOString().split('T')[0], isInstallment: true, installCount, installGroupId: groupId });
                }
            } else if (isFixed) {
                const baseDate = new Date(date + 'T12:00:00');
                const groupId = Date.now();
                for (let i = 0; i < fixedDuration; i++) {
                    const d = new Date(baseDate); d.setMonth(baseDate.getMonth() + i);
                    transactions.push({ ...baseData, id: groupId + i, date: d.toISOString().split('T')[0], isFixed: true, fixedDuration, fixedGroupId: groupId });
                }
            } else {
                transactions.push({ ...baseData, id: Date.now(), isInstallment: false, isFixed: false });
            }
            closeModal(); render();
        }

        init();
    </script>
</body>
</html>
